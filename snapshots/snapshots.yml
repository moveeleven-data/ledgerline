version: 2

snapshots:
  - name: SNSH_ABC_BANK_POSITION
    description: SCD check of ABC Bank positions. Tests are gated off unless enable_snapshots is true.

    columns:
      - name: POSITION_HKEY
        description: Surrogate key for a position (account_code + security_code).
        tests:
          - hash_collision_free:
              name: pos_hkey_no_collision
              arguments:
                hashed_fields:
                  - ACCOUNT_CODE
                  - SECURITY_CODE
              config:
                enabled: "{{ var('enable_snapshots', false) }}"

      - name: POSITION_HDIFF
        description: Diff hash of all change-relevant attributes for a position record.
        tests:
          - hash_collision_free:
              name: pos_hdiff_no_collision
              arguments:
                hashed_fields:
                  - ACCOUNT_CODE
                  - SECURITY_CODE
                  - SECURITY_NAME
                  - EXCHANGE_CODE
                  - "to_varchar(REPORT_DATE, 'YYYY-MM-DD')"
                  - QUANTITY
                  - COST_BASE
                  - POSITION_VALUE
                  - CURRENCY_CODE
              config:
                enabled: "{{ var('enable_snapshots', false) }}"