version: 2

models:
  - name: REF_USAGE_ATLAS
    description: Latest valid OPEN usage rows per key and day.

    columns:
      - name: USAGE_HKEY
        tests: [not_null, unique]

      - name: REPORT_DATE
        tests: [not_null]

      - name: CUSTOMER_CODE
        tests: [not_null]

      - name: PRODUCT_CODE
        tests: [not_null]

      - name: PLAN_CODE
        tests: [not_null]

      - name: UNITS_USED
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "units_used >= 0"

      - name: INCLUDED_UNITS
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "included_units >= 0"

      - name: OVERAGE_UNITS
        tests:
          - dbt_utils.expression_is_true:
              expression: "overage_units >= 0"



  - name: REF_CUSTOMER_ATLAS
    description: Customer attributes with hashed surrogate key.

    tests:
      - has_default_key:
          column_name: CUSTOMER_CODE

      - warn_on_multiple_default_key:
          column_name: CUSTOMER_CODE

      - no_default_clash:
          code_col: CUSTOMER_CODE

    columns:
      - name: CUSTOMER_HKEY
        tests: [not_null, unique]

      - name: CUSTOMER_CODE
        tests: [not_null]

      - name: COUNTRY_CODE2
        tests: [not_null]



  - name: REF_PRODUCT_ATLAS
    description: Product master attributes.

    tests:
      - has_default_key:
          column_name: PRODUCT_CODE

      - warn_on_multiple_default_key:
          column_name: PRODUCT_CODE

      - no_default_clash:
          code_col: PRODUCT_CODE

    columns:
      - name: PRODUCT_HKEY
        tests: [not_null, unique]

      - name: PRODUCT_CODE
        tests: [not_null]

      - name: PRODUCT_NAME
        tests: [not_null]



  - name: REF_PLAN_ATLAS
    description: Subscription plan attributes.

    tests:
      - has_default_key:
          column_name: PLAN_CODE

      - warn_on_multiple_default_key:
          column_name: PLAN_CODE

      - no_default_clash:
          code_col: PLAN_CODE

    columns:
      - name: PLAN_HKEY
        tests: [not_null, unique]

      - name: PLAN_CODE
        tests: [not_null]

      - name: PRODUCT_CODE
        tests: [not_null]



  - name: REF_CURRENCY_ATLAS
    description: Currency reference data.

    tests:
      - has_default_key:
          column_name: CURRENCY_CODE

      - warn_on_multiple_default_key:
          column_name: CURRENCY_CODE

      - no_default_clash:
          code_col: CURRENCY_CODE

    columns:
      - name: CURRENCY_HKEY
        tests: [not_null, unique]

      - name: CURRENCY_CODE
        tests: [not_null]

      - name: CURRENCY_NAME
        tests: [not_null]



  - name: REF_COUNTRY_ATLAS
    description: Country reference data.

    tests:
      - has_default_key:
          column_name: COUNTRY_CODE2

      - warn_on_multiple_default_key:
          column_name: COUNTRY_CODE2

      - no_default_clash:
          code_col: COUNTRY_CODE2

    columns:
      - name: COUNTRY_HKEY
        tests: [not_null, unique]

      - name: COUNTRY_CODE2
        tests: [not_null]

      - name: COUNTRY_NAME
        tests: [not_null]



  - name: REF_USAGE_ATLAS__invalid
    description: Rows that violate basic validity rules and should be empty after a clean load.
