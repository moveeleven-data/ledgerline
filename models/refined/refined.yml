# refined.yml
# ------------------------------------------------------------------------------------
# Refined layer: cleaned and standardized models shaped for reuse and to feed marts.
# This file documents column-level tests and default-key integrity checks.
# ------------------------------------------------------------------------------------

version: 2

models:

  # ---------------------------------------------------------------------------------
  # ref_usage_atlas
  # ---------------------------------------------------------------------------------
  # Refined usage rows, one per customer_code + product_code + plan_code + day.
  # Column tests ensure required fields are present and nonnegative where expected.
  # ---------------------------------------------------------------------------------

  - name: ref_usage_atlas
    description: Refined usage rows (one per cust/product/plan/day)
    columns:

      - name: customer_code
        tests:
          - not_null

      - name: product_code
        tests:
          - not_null

      - name: plan_code
        tests:
          - not_null

      - name: report_date
        tests:
          - not_null

      - name: units_used
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: included_units
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: overage_units
        description: Computed as GREATEST(units_used - included_units, 0)
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"


  # -----------------------------------------------------------------------
  # ref_customer_atlas
  # -----------------------------------------------------------------------
  # Customer attributes with hashed surrogate key.
  # Default-key tests enforce presence, uniqueness posture, and no clash.
  # -----------------------------------------------------------------------

  - name: ref_customer_atlas
    description: Customer attributes with hashed surrogate key.

    tests:
      - has_default_key:
          arguments:
            column_name: customer_code
      - warn_on_multiple_default_key:
          arguments:
            surrogate_key_column: customer_code
      - no_default_clash:
          arguments:
            surrogate_key_column: customer_code

    columns:
      - name: customer_hkey
        tests: [not_null, unique]

      - name: customer_code
        tests: [not_null]

      - name: country_code2
        tests: [not_null]


  # -----------------------------------------------------------------------
  # ref_product_atlas
  # -----------------------------------------------------------------------
  # Product master attributes with default-key integrity checks.
  # -----------------------------------------------------------------------

  - name: ref_product_atlas
    description: Product master attributes.

    tests:
      - has_default_key:
          arguments:
            column_name: product_code
      - warn_on_multiple_default_key:
          arguments:
            surrogate_key_column: product_code
      - no_default_clash:
          arguments:
            surrogate_key_column: product_code

    columns:
      - name: product_hkey
        tests: [not_null, unique]

      - name: product_code
        tests: [not_null]

      - name: product_name
        tests: [not_null]


  # -----------------------------------------------------------------------
  # ref_plan_atlas
  # -----------------------------------------------------------------------
  # Subscription plan attributes with default-key integrity checks.
  # -----------------------------------------------------------------------

  - name: ref_plan_atlas
    description: Subscription plan attributes.

    tests:
      - has_default_key:
          arguments:
            column_name: plan_code
      - warn_on_multiple_default_key:
          arguments:
            surrogate_key_column: plan_code
      - no_default_clash:
          arguments:
            surrogate_key_column: plan_code

    columns:
      - name: plan_hkey
        tests: [not_null, unique]

      - name: plan_code
        tests: [not_null]

      - name: product_code
        tests: [not_null]


  # -----------------------------------------------------------------------
  # ref_currency_atlas
  # -----------------------------------------------------------------------
  # Currency reference data with default-key integrity checks.
  # -----------------------------------------------------------------------

  - name: ref_currency_atlas
    description: Currency reference data.

    tests:
      - has_default_key:
          arguments:
            column_name: currency_code
      - warn_on_multiple_default_key:
          arguments:
            surrogate_key_column: currency_code
      - no_default_clash:
          arguments:
            surrogate_key_column: currency_code

    columns:
      - name: currency_hkey
        tests: [not_null, unique]

      - name: currency_code
        tests: [not_null]

      - name: currency_name
        tests: [not_null]


  # -----------------------------------------------------------------------
  # ref_country_atlas
  # -----------------------------------------------------------------------
  # Country reference data with default-key integrity checks.
  # -----------------------------------------------------------------------

  - name: ref_country_atlas
    description: Country reference data.

    tests:
      - has_default_key:
          arguments:
            column_name: country_code2
      - warn_on_multiple_default_key:
          arguments:
            surrogate_key_column: country_code2
      - no_default_clash:
          arguments:
            surrogate_key_column: country_code2

    columns:
      - name: country_hkey
        tests: [not_null, unique]

      - name: country_code2
        tests: [not_null]

      - name: country_name
        tests: [not_null]
