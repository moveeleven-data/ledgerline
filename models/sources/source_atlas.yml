# source_atlas_yml
# -----------------------------------------------------------------------------------
# Defines the contract for the atlas_meter usage feed, which dbt does not create.
# Six inputs are seeds (CRM, catalog, countries, currencies, price book), but this
# feed is a true source. In dev it points at seeded data, in prod it points at the
# raw ingestion schema. This file declares where to find it, how fresh it should be,
# and what its columns mean.
# -----------------------------------------------------------------------------------

version: 2

sources:
  - name: atlas_meter

    # "atlas_meter" is the logical label. We'll use this in code like:
    # source('atlas_meter', 'atlas_meter_usage_daily')

    database: "{{ target.database }}"   # Portable across dev/prod/CI

    schema: "{{ env_var('DBT_ATLAS_METER_SCHEMA', target.schema ~ '_seeds') }}"
    tags: ['source','domain:usage_billing','data_product:ledgerline']
    meta:
      owner: 'Matthew Tripodi'
      domain: 'usage_billing'
      data_product: 'ledgerline'
      source_system: 'atlas_meter'
      sla_hours: 24
      pii: false

    # --------------------------------------------------------------------------
    # Schema Resolution
    # --------------------------------------------------------------------------
    # Dev/CI: schema = <target.schema>_seeds
    #   - Reads from seeded CSVs checked into the repo.
    #   - Developers/CI don’t need a live ingestion feed.
    #
    # Prod: schema = DBT_ATLAS_METER_SCHEMA (env var)
    #   - Points to the raw ingestion schema (e.g. source_data).
    #
    # Same dbt code works in both modes. Everyone develops/tests against the
    # same seed snapshot, while prod uses real data.
    # --------------------------------------------------------------------------

    tables:
      - name: atlas_meter_usage_daily         # dbt alias
        identifier: atlas_meter_usage_daily   # Physical table name (warehouse object)
        tags: ['source_table','domain:usage_billing']
        meta:
          owner: 'Matthew Tripodi'
          domain: 'usage_billing'
          data_product: 'ledgerline'
          freshness_sla_hours: 36
          pii: false

        description: >
          Daily metered usage feed at grain customer + product + plan + day.
          In bootstrap mode this is a seeded table. In production it points to
          the raw landed usage feed.


        # ----------------------------------------------------------------------
        # Freshness
        # ----------------------------------------------------------------------
        # Uses load_ts as the freshness indicator.
        # - Warn if data is more than 36 hours old
        # - Error if more than 72 hours old
        # ----------------------------------------------------------------------
          
        loaded_at_field: load_ts
        freshness:
          warn_after: {count: 36, period: hour}
          error_after: {count: 72, period: hour}


        # ---------------------------------------------------------------------------
        # Tests
        # ---------------------------------------------------------------------------
        # Validates source contract:
        # - Exactly one row per customer/product/plan/day
        # - Duplicates indicate a broken upstream feed (staging can only mask issues)
        # ---------------------------------------------------------------------------

        tests:
          - dbt_utils.unique_combination_of_columns:
              arguments:
                combination_of_columns: [customer_code, product_code, plan_code, report_date]
              config:
                severity: warn


        # ------------------------------------------------------------------------
        # Columns
        # ------------------------------------------------------------------------
        # Downstream contract for staging and marts. Each column’s meaning is
        # fixed here. Upstream changes are caught before they flow further.
        # - customer_code is the anchor key for downstream dims
        # - report_date is the analytic anchor (UTC daily grain, churn, ARR, etc.)
        # ------------------------------------------------------------------------

        columns:
          - name: customer_code  # External identity of a customer.
            description: Customer code from CRM (joins to dim_customer)

          - name: product_code   # Identifier for which product the customer actually used
            description: Product or feature code (joins to dim_product)

          - name: plan_code      # Decides how a customer is billed (monthly vs annual, free vs pro)
            description: Subscription plan code (joins to dim_plan)

          - name: report_date    # True business date the usage happened on (not ingestion timestamp)
            description: Usage as-of date (daily UTC calendar grain)
