# source_atlas.yml
# ---------------------------------------------------------------------------
# Schema definition for the Atlas metering feed (atlas_meter_usage_daily).
#
# In dev/CI it resolves to seeded tables, in prod it resolves to the
# raw ingestion schema. This file pins the contract for location,
# freshness, grain, and columns.
# ---------------------------------------------------------------------------

version: 2

sources:
  - name: atlas_meter
  
    database: "{{ target.database }}"   # Portable across dev/prod/CI

    # -------------------------------------------------------------------------
    # Schema Resolution
    # --------------------------------------------------------------------------
    # Studio and Dev jobs:
    #   schema = dbt_mtripodi_seeds (from Project default)
    #   - Reads from seeded CSVs so development and CI builds are reproducible.
    #
    # Prod jobs:
    #   schema = source_data (from DBT_ATLAS_METER_SCHEMA env var)
    #   - Points to the raw ingestion schema with live usage data.
    # --------------------------------------------------------------------------

    schema: "{{ env_var('DBT_ATLAS_METER_SCHEMA', target.schema ~ '_seeds') }}"
    tags: ['source','domain:usage_billing','data_product:ledgerline']
    meta:
      owner: 'Matthew Tripodi'
      domain: 'usage_billing'
      data_product: 'ledgerline'
      source_system: 'atlas_meter'
      sla_hours: 24
      pii: false

    tables:
      - name: atlas_meter_usage_daily         # dbt alias
        identifier: atlas_meter_usage_daily   # Physical table name (warehouse object)
        tags: ['source_table','domain:usage_billing']
        meta:
          owner: 'Matthew Tripodi'
          domain: 'usage_billing'
          data_product: 'ledgerline'
          freshness_sla_hours: 36
          pii: false

        description: >
          Daily metered usage feed at grain customer + product + plan + day.
          In bootstrap mode this is a seeded table. In production it points to
          the raw landed usage feed.


        # ----------------------------------------------------------------------
        # Freshness
        # ----------------------------------------------------------------------
        # Uses load_ts as the freshness indicator.
        # - Warn if data is more than 36 hours old
        # - Error if more than 72 hours old
        # ----------------------------------------------------------------------
          
        loaded_at_field: load_ts
        freshness:
          warn_after: {count: 36, period: hour}
          error_after: {count: 72, period: hour}


        # ---------------------------------------------------------------------------
        # Tests
        # ---------------------------------------------------------------------------
        # Validates source contract:
        # - Exactly one row per customer/product/plan/day
        # - Duplicates indicate a broken upstream feed (staging can only mask issues)
        # ---------------------------------------------------------------------------

        tests:
          - dbt_utils.unique_combination_of_columns:
              arguments:
                combination_of_columns: [customer_code, product_code, plan_code, report_date]
              config:
                severity: warn


        # ------------------------------------------------------------------------
        # Columns
        # ------------------------------------------------------------------------
        # Downstream contract for staging and marts. Each columnâ€™s meaning is
        # fixed here. Upstream changes are caught before they flow further.
        # - customer_code is the anchor key for downstream dims
        # - report_date is the analytic anchor (UTC daily grain, churn, ARR, etc.)
        # ------------------------------------------------------------------------

        columns:
          - name: customer_code  # External identity of a customer.
            description: Customer code from CRM (joins to dim_customer)

          - name: product_code   # Identifier for which product the customer actually used
            description: Product or feature code (joins to dim_product)

          - name: plan_code      # Decides how a customer is billed (monthly vs annual, free vs pro)
            description: Subscription plan code (joins to dim_plan)

          - name: report_date    # True business date the usage happened on (not ingestion timestamp)
            description: Usage as-of date (daily UTC calendar grain)
