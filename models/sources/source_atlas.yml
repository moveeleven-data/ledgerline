version: 2

sources:
  - name: atlas_meter
    database: "{{ target.database }}"
    # Environment variable selects the schema.
    # - Dev/local: ATLAS_METER_SCHEMA = seeds
    # - Prod:      ATLAS_METER_SCHEMA = source_data
    schema: "{{ env_var('DBT_ATLAS_METER_SCHEMA') }}"

    tables:
      - name: atlas_meter_usage_daily
        identifier: atlas_meter_usage_daily
        description: >
          Daily metered usage feed at grain customer x product x plan x day.
          For the bootstrap build this points at the seeded table. Swap schema back
          to source_data when you wire the real landing table.
        loaded_at_field: load_ts

        freshness:
          warn_after: {count: 36, period: hour}
          error_after: {count: 72, period: hour}

        tests:
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns: [customer_code, product_code, plan_code, report_date]
              config:
                severity: warn

        columns:
          - name: customer_code
            description: Customer code from CRM

          - name: product_code
            description: Product or feature code

          - name: plan_code
            description: Subscription plan code

          - name: report_date
            description: Usage as-of date
