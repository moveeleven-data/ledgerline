version: 2

models:
  - name: HIST_ABC_BANK_POSITION
    description: >
      SCD positions history. 'OPEN' rows come from the source for each report_date;
      'CLOSE_SYNTHETIC' rows are zero-outs created when a previously OPEN position
      is absent on the latest report_date (one close per key/date).

    columns:
      - name: POSITION_HKEY
        description: Surrogate key for (account_code, security_code).
        tests:
          - not_null

      - name: POSITION_HDIFF
        description: Version hash over identifying + numeric fields (includes REPORT_DATE).
        tests:
          - not_null
          - unique  # each daily version is a distinct diff

      - name: REPORT_DATE
        description: Business date of the position snapshot.
        tests:
          - not_null

      - name: POSITION_ROW_TYPE
        description: Row classification ('OPEN' from source; 'CLOSE_SYNTHETIC' generated on disappearance).
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['OPEN', 'CLOSE_SYNTHETIC']


    tests:
      # Exactly one row per (key, date)
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['POSITION_HKEY','REPORT_DATE']
