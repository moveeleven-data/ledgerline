version: 2

models:
  - name: HIST_ABC_BANK_POSITION
    description: >
      SCD positions history. 'OPEN' rows come from the source for each report_date;
      'CLOSE_SYNTHETIC' rows are zero-outs created when a previously OPEN position
      is absent on the latest report_date (one close per key/date).

    columns:
      - name: POSITION_HKEY
        description: Surrogate key for (account_code, security_code).
        tests:
          - not_null

      - name: POSITION_HDIFF
        description: Version hash over identifying + numeric fields (includes REPORT_DATE).
        tests:
          - not_null
          - unique  # each daily version is a distinct diff

      - name: REPORT_DATE
        description: Business date of the position snapshot.
        tests:
          - not_null

      - name: POSITION_ROW_TYPE
        description: Row classification ('OPEN' from source; 'CLOSE_SYNTHETIC' generated on disappearance).
        tests:
          - accepted_values:
              arguments:
                values: ['OPEN', 'CLOSE_SYNTHETIC']

    tests:
      # Exactly one row per (key, date, row_type)
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns: ['POSITION_HKEY','REPORT_DATE','POSITION_ROW_TYPE']

      # Hashes should not collide for either HKEY or HDIFF
      - hash_collision_free:
          column_name: POSITION_HKEY
          hashed_fields:
            - account_code
            - security_code
      - hash_collision_free:
          column_name: POSITION_HDIFF
          hashed_fields:
            - account_code
            - security_code
            - security_name
            - exchange_code
            - "to_varchar(report_date, 'YYYY-MM-DD')"
            - quantity
            - cost_base
            - position_value
            - currency_code
