# history.yml
# -----------------------------------------------------------------------------------
# History layer: SCD usage history.
# - 'OPEN' rows come from the source for each report_date
# - 'CLOSE_SYNTHETIC' rows are zero-outs created when an OPEN combo disappears
#   on the latest report_date (one close per key and date).
# -----------------------------------------------------------------------------------

models:

  # --------------------------------------------------------------------------
  # hist_atlas_meter_usage_daily
  # --------------------------------------------------------------------------
  # Tracks full change history for usage. Surrogate keys and version hashes
  # guarantee stability and detect changes. Row types enforce SCD contract.
  # --------------------------------------------------------------------------
  
  - name: hist_atlas_meter_usage_daily
    description: >
      SCD usage history. 'OPEN' rows come from the source for each report_date;
      'CLOSE_SYNTHETIC' rows are zero-outs created when a previously OPEN usage
      combo is absent on the latest report_date (one close per key and date).

    columns:
      - name: usage_hkey
        description: Surrogate key for (customer_code, product_code, plan_code, report_date bucket).
        tests: [not_null]

      - name: usage_hdiff
        description: Version hash over identifying fields and units (includes report_date).
        tests:
          - not_null
          - unique

      - name: report_date
        tests: [not_null]

      - name: usage_row_type
        tests:
          - accepted_values:
              arguments:
                values: ['OPEN','CLOSE_SYNTHETIC']


    # ----------------------------------------------------------------------
    # Tests
    # ----------------------------------------------------------------------
    # Validates uniqueness and hash integrity:
    # - Unique combo of (usage_hkey, report_date, usage_row_type)
    # - usage_hkey and usage_hdiff must be collision-free
    # ----------------------------------------------------------------------

    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - usage_hkey
              - report_date
              - usage_row_type

      - hash_collision_free:
          arguments:
            hash_column: usage_hkey
            source_columns:
              - customer_code
              - product_code
              - plan_code
              - "to_varchar(report_date, 'YYYY-MM-DD')"

      - hash_collision_free:
          arguments:
            hash_column: usage_hdiff
            source_columns:
              - customer_code
              - product_code
              - plan_code
