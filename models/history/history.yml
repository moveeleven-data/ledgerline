version: 2

models:
  - name: hist_atlas_meter_usage_daily
    description: >
      SCD usage history. 'OPEN' rows come from the source for each report_date;
      'CLOSE_SYNTHETIC' rows are zero-outs created when a previously OPEN usage
      combo is absent on the latest report_date (one close per key and date).

    columns:
      - name: usage_hkey
        description: Surrogate key for (customer_code, product_code, plan_code, report_date bucket).
        tests: [not_null]

      - name: usage_hdiff
        description: Version hash over identifying fields and units (includes report_date).
        tests:
          - not_null
          - unique

      - name: report_date
        tests: [not_null]

      - name: usage_row_type
        tests:
          - accepted_values:
              values: ['OPEN', 'CLOSE_SYNTHETIC']

    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['usage_hkey','report_date','usage_row_type']

      - hash_collision_free:
          column_name: usage_hkey
          hashed_fields:
            - customer_code
            - product_code
            - plan_code
            - "to_varchar(report_date, 'YYYY-MM-DD')"

      - hash_collision_free:
          column_name: usage_hdiff
          hashed_fields:
            - customer_code
            - product_code
            - plan_code
