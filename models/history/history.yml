# history.yml
# ---------------------------------------------------------------------------
# Schema definitions for the History layer.
#
# This layer preserves full change history for both reference data
# and usage spans. It makes time explicit by storing surrogate keys,
# version hashes, and row types (OPEN / CLOSE_SYNTHETIC).
# ---------------------------------------------------------------------------

models:

  # --------------------------------------------------------------------------
  # hist_atlas_meter_usage_daily
  # --------------------------------------------------------------------------
  # Tracks full change history for usage. Surrogate keys and version hashes
  # guarantee stability and detect changes. Row types enforce SCD contract.
  # --------------------------------------------------------------------------

  - name: hist_atlas_meter_usage_daily

    description: >
      Append only usage history. Stores what arrived and when.
      REF selects the latest per key and date for reporting.

    columns:
      - name: usage_hkey
        tests: [not_null]
      - name: usage_hdiff
        tests: [not_null]
      - name: report_date
        tests: [not_null]
      - name: ingestion_ts
        tests: [not_null]


    # ----------------------------------------------------------------------
    # Tests
    # ----------------------------------------------------------------------
    # Validates uniqueness and hash integrity:
    # - Unique combo of (usage_hkey, report_date, usage_row_type)
    # - usage_hkey and usage_hdiff must be collision-free
    # ----------------------------------------------------------------------

    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - usage_hkey
              - report_date
              - usage_row_type

      - hash_collision_free:
          arguments:
            hash_column: usage_hkey
            source_columns:
              - customer_code
              - product_code
              - plan_code
              - "to_varchar(report_date, 'YYYY-MM-DD')"

      - hash_collision_free:
          arguments:
            hash_column: usage_hdiff
            source_columns:
              - customer_code
              - product_code
              - plan_code
