# fact_usage_window.yml
# ----------------------------------------------------------------------
# Windowed fact table for EDA. Keeps daily rows over a chosen date range
# so you can analyze streaks, distributions, and trends. Exists alongside
# fact_usage, which stays limited to the latest day for finance reporting.
# ----------------------------------------------------------------------

version: 2

models:
  - name: fact_usage_window
    description: >
      Daily usage and billing fact over a configurable date range.
      Mirrors fact_usage logic but keeps every day so EDA visuals
      can show patterns over time. Not for finance reporting.

    config:
      contract:
        enforced: true
      tags: ['mart:usage','fact','eda','domain:usage_billing']

    meta:
      owner: 'Matthew Tripodi'
      domain: 'usage_billing'
      layer: 'marts'
      mart: 'usage'
      tier: 'gold'
      sla_hours: 24
      pii: false

    tests:
      - dbt_utils.unique_combination_of_columns:
          name: fact_usage_window_unique_combo
          arguments:
            combination_of_columns:
              - customer_key
              - product_key
              - plan_key
              - report_date

    columns:
      - name: customer_key
        data_type: string
        tests:
          - not_null
          - relationships:
              arguments: {to: ref('dim_customer'), field: customer_key}

      - name: product_key
        data_type: string
        tests:
          - not_null
          - relationships:
              arguments: {to: ref('dim_product'), field: product_key}

      - name: plan_key
        data_type: string
        tests:
          - not_null
          - relationships:
              arguments: {to: ref('dim_plan'), field: plan_key}

      - name: currency_key
        data_type: string
        tests:
          - not_null
          - relationships:
              arguments: {to: ref('dim_currency'), field: currency_key}

      - name: report_date
        data_type: date
        tests: [not_null]

      - name: units_used
        data_type: number(38,0)

      - name: included_units
        data_type: number(38,0)

      - name: overage_units
        data_type: number(38,0)

      - name: unit_price
        data_type: number(38,6)

      - name: billed_value
        data_type: number(38,6)

      - name: included_value
        data_type: number(38,6)

      - name: overage_value
        data_type: number(38,6)

      - name: overage_share
        data_type: number(38,6)