# intfact_usage_priced_window.yml
# ----------------------------------------------------------------------
# Intermediate model for EDA. Prices usage across a configurable date
# window using the same rules as int_fact_usage_priced but keeps all
# days for exploratory analysis.
# ----------------------------------------------------------------------

version: 2

models:
  - name: int_fact_usage_priced_window
    description: >
      Priced usage for a date window at the natural-key grain.
      Computes overages and applies the most recent unit_price.
      Supports fact_usage_window and other EDA models.

    config:
      contract:
        enforced: true
      tags: ['mart:usage','intermediate','eda','domain:usage_billing']

    meta:
      owner: 'Matthew Tripodi'
      domain: 'usage_billing'
      layer: 'marts'
      mart: 'usage'
      tier: 'silver'
      pii: false

    tests:
      - dbt_utils.unique_combination_of_columns:
          name: int_fact_usage_priced_window_unique_combo
          arguments:
            combination_of_columns:
              - report_date
              - customer_code_nk
              - product_code_nk
              - plan_code_nk

    columns:
      - name: report_date
        description: Usage reporting date.
        data_type: date
        tests: [not_null]

      - name: customer_code_nk
        description: Natural key for customer.
        data_type: string
        tests: [not_null]

      - name: product_code_nk
        description: Natural key for product.
        data_type: string
        tests: [not_null]

      - name: plan_code_nk
        description: Natural key for plan.
        data_type: string
        tests: [not_null]

      - name: units_used
        description: Units consumed on report_date.
        data_type: number(38,0)

      - name: included_units
        description: Included units on report_date.
        data_type: number(38,0)

      - name: overage_units
        description: greatest(units_used - included_units, 0).
        data_type: number(38,0)

      - name: unit_price
        description: Last effective unit price on or before report_date.
        data_type: number(18,6)

      - name: currency_code_nk
        description: Pricing currency code.
        data_type: string
        tests: [not_null]