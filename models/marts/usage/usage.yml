# usage.yml
# -----------------------------------------------------------------------------------
# The Usage Mart is a curated business-facing layer for customer usage data.
# Contains conformed dimensions (customer, product, plan, currency, country)
# and the fact_usage table at daily grain. All models enforce contracts to
# guarantee schema stability and quality.
# -----------------------------------------------------------------------------------

version: 2

models:

  # --------------------------------------------------------------------------
  # dim_customer
  # --------------------------------------------------------------------------
  # Dimension: Customer attributes for the usage mart.
  # One row per natural customer_code.
  # --------------------------------------------------------------------------

  - name: dim_customer
    description: Customer attributes for the usage mart. One row per natural customer_code.
    config:
      contract:
        enforced: true
    tags: ['mart:usage','dimension','domain:usage_billing']
    meta:
      owner: 'Matthew Tripodi'
      domain: 'usage_billing'
      layer: 'marts'
      mart: 'usage'
      tier: 'gold'
      pii: false

    columns:
      - name: customer_key
        data_type: string
        tests: [not_null, unique]

      - name: customer_code
        data_type: string
        tests: [not_null, unique]

      - name: customer_name
        data_type: string
        tests: [not_null]

      - name: country_code
        data_type: string


  # --------------------------------------------------------------------------
  # dim_product
  # --------------------------------------------------------------------------
  # Dimension: Product master used by the usage mart.
  # Self-completes missing codes with a default member.
  # --------------------------------------------------------------------------

  - name: dim_product
    description: Product master used by the usage mart. Self completes missing codes from facts using the default member.
    config:
      contract:
        enforced: true
    tags: ['mart:usage','dimension','domain:usage_billing']
    meta:
      owner: 'Matthew Tripodi'
      domain: 'usage_billing'
      layer: 'marts'
      mart: 'usage'
      tier: 'gold'
      pii: false

    columns:
      - name: product_key
        data_type: string
        tests: [not_null, unique]

      - name: product_code
        data_type: string
        tests: [not_null, unique]

      - name: product_name
        data_type: string
        tests: [not_null]

      - name: category
        data_type: string


  # --------------------------------------------------------------------------
  # dim_plan
  # --------------------------------------------------------------------------
  # Dimension: Subscription plans offered under each product.
  # Drives billing logic (billing_period, included units, pricing).
  # --------------------------------------------------------------------------

  - name: dim_plan
    description: Subscription plan catalog for the usage mart.
    config:
      contract:
        enforced: true
    tags: ['mart:usage','dimension','domain:usage_billing']
    meta:
      owner: 'Matthew Tripodi'
      domain: 'usage_billing'
      layer: 'marts'
      mart: 'usage'
      tier: 'gold'
      pii: false

    columns:
      - name: plan_key
        data_type: string
        tests: [not_null, unique]

      - name: plan_code
        data_type: string
        tests: [not_null, unique]

      - name: plan_name
        data_type: string
        tests: [not_null]

      - name: product_code
        data_type: string
        tests: [not_null]

      - name: billing_period
        data_type: string


  # --------------------------------------------------------------------------
  # dim_currency
  # --------------------------------------------------------------------------
  # Dimension: Currency reference data.
  # Joined to facts when pricing is currency specific.
  # --------------------------------------------------------------------------

  - name: dim_currency
    description: Currency reference data joined to facts when pricing is currency specific.
    config:
      contract:
        enforced: true
    tags: ['mart:usage','dimension','domain:usage_billing']
    meta:
      owner: 'Matthew Tripodi'
      domain: 'usage_billing'
      layer: 'marts'
      mart: 'usage'
      tier: 'gold'
      pii: false

    columns:
      - name: currency_key
        data_type: string
        tests: [not_null, unique]

      - name: currency_code
        data_type: string
        tests: [not_null, unique]

      - name: decimal_digits
        data_type: number(38,0)

      - name: currency_name
        data_type: string
        tests: [not_null]


  # --------------------------------------------------------------------------
  # dim_country
  # --------------------------------------------------------------------------
  # Dimension: Country reference data.
  # Used for enrichment and rollups.
  # --------------------------------------------------------------------------

  - name: dim_country
    description: Country reference data for enrichment and rollups.
    config:
      contract:
        enforced: true
    tags: ['mart:usage','dimension','domain:usage_billing']
    meta:
      owner: 'Matthew Tripodi'
      domain: 'usage_billing'
      layer: 'marts'
      mart: 'usage'
      tier: 'gold'
      pii: false

    columns:
      - name: country_key
        data_type: string
        tests: [not_null, unique]

      - name: country_code
        data_type: string
        tests: [not_null, unique]

      - name: country_name
        data_type: string
        tests: [not_null]


  # --------------------------------------------------------------------------
  # fact_usage
  # --------------------------------------------------------------------------
  # Fact table: Daily usage by customer, product, plan, per report_date.
  # One row per (customer_key, product_key, plan_key, report_date).
  # --------------------------------------------------------------------------

  - name: fact_usage
    description: Daily usage by customer, product, plan, per report_date. One row per (customer_key, product_key, plan_key, report_date).
    config:
      contract:
        enforced: true
    tags: ['mart:usage','fact','domain:usage_billing']
    meta:
      owner: 'Matthew Tripodi'
      domain: 'usage_billing'
      layer: 'marts'
      mart: 'usage'
      tier: 'gold'
      sla_hours: 24
      pii: false

    # ----------------------------------------------------------------------
    # Tests
    # ----------------------------------------------------------------------
    # Ensures uniqueness across the business grain:
    # (customer_key, product_key, plan_key, report_date).
    # ----------------------------------------------------------------------
    
    tests:
      - dbt_utils.unique_combination_of_columns:
          name: fact_usage_unique_combo
          combination_of_columns:
            - customer_key
            - product_key
            - plan_key
            - report_date

    columns:
      - name: customer_key
        data_type: string
        tests:
          - not_null
          - relationships:
              to: ref('dim_customer')
              field: customer_key

      - name: product_key
        data_type: string
        tests:
          - not_null
          - relationships:
              to: ref('dim_product')
              field: product_key

      - name: plan_key
        data_type: string
        tests:
          - not_null
          - relationships:
              to: ref('dim_plan')
              field: plan_key

      - name: report_date
        data_type: date
        tests: [not_null]

      - name: units_used
        data_type: number(38,0)

      - name: included_units
        data_type: number(38,0)

      - name: overage_units
        data_type: number(38,0)

      - name: unit_price
        data_type: number(38,6)

      - name: billed_value
        data_type: number(38,6)

      - name: included_value
        data_type: number(38,6)

      - name: overage_value
        data_type: number(38,6)

      - name: overage_share
        data_type: number(38,6)
