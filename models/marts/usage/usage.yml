# usage.yml
# ---------------------------------------------------------------------------
# Schema definitions for all models in marts/usage.
# ---------------------------------------------------------------------------

version: 2

# ==============================================================================
# Models
# ==============================================================================

models:

  # ---------------------------------------------------------------------------
  # dim_customer
  # ---------------------------------------------------------------------------

  - name: dim_customer
    description: Customer dimension (pass-through from REF).
    contract:
      enforced: true

    columns:
      - name: customer_key
        data_type: string
        tests: [not_null, unique]

      - name: customer_code
        data_type: string
        tests: [not_null]

      - name: customer_name
        data_type: string
        tests: [not_null]

      - name: country_code
        data_type: string


  # ---------------------------------------------------------------------------
  # dim_product
  # ---------------------------------------------------------------------------

  - name: dim_product
    description: Product dimension (pass-through from REF).
    contract:
      enforced: true

    columns:
      - name: product_key
        data_type: string
        tests: [not_null, unique]

      - name: product_code
        data_type: string
        tests: [not_null]

      - name: product_name
        data_type: string
        tests: [not_null]

      - name: category
        data_type: string


  # ---------------------------------------------------------------------------
  # dim_plan
  # ---------------------------------------------------------------------------

  - name: dim_plan
    description: Plan dimension (pass-through from REF).
    contract:
      enforced: true

    columns:
      - name: plan_key
        data_type: string
        tests: [not_null, unique]

      - name: plan_code
        data_type: string
        tests: [not_null]

      - name: plan_name
        data_type: string
        tests: [not_null]

      - name: product_code
        data_type: string
        tests: [not_null]

      - name: billing_period
        data_type: string


  # ---------------------------------------------------------------------------
  # dim_country
  # ---------------------------------------------------------------------------

  - name: dim_country
    description: Country dimension (pass-through from REF, closed domain).
    contract:
      enforced: true

    columns:
      - name: country_key
        data_type: string
        tests: [not_null, unique]

      - name: country_code
        data_type: string
        tests: [not_null]

      - name: country_name
        data_type: string
        tests: [not_null]


  # ---------------------------------------------------------------------------
  # int_fact_usage_priced
  # ---------------------------------------------------------------------------

  - name: int_fact_usage_priced
    description: Usage priced at NK grain (REF usage + REF price book wrapper).
    contract:
      enforced: true

    columns:
      - name: report_date
        data_type: date
        tests: [not_null]

      - name: customer_key
        data_type: string
        tests: [not_null]

      - name: product_key
        data_type: string
        tests: [not_null]

      - name: plan_key
        data_type: string
        tests: [not_null]

      - name: units_used
        data_type: number(38,0)

      - name: included_units
        data_type: number(38,0)

      - name: overage_units
        data_type: number(38,0)

      - name: unit_price
        data_type: number(18,6)

      - name: billed_value
        data_type: number(18,6)

      - name: included_value
        data_type: number(18,6)

      - name: overage_value
        data_type: number(18,6)

      - name: overage_share
        data_type: number(18,6)

  # ---------------------------------------------------------------------------
  # fact_usage
  # ---------------------------------------------------------------------------

  - name: fact_usage
    description: Daily usage fact; no dim joins; keys flow from REF or pricing step.
    contract:
      enforced: true

    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - customer_key
              - product_key
              - plan_key
              - report_date

    columns:
      - name: customer_key
        data_type: string

      - name: product_key
        data_type: string

      - name: plan_key
        data_type: string

      - name: report_date
        data_type: date

      - name: units_used
        data_type: number(38,0)

      - name: included_units
        data_type: number(38,0)

      - name: overage_units
        data_type: number(38,0)

      - name: unit_price
        data_type: number(18,6)

      - name: billed_value
        data_type: number(18,6)

      - name: included_value
        data_type: number(18,6)

      - name: overage_value
        data_type: number(18,6)
        
      - name: overage_share
        data_type: number(18,6)



  # ---------------------------------------------------------------------------
  # profile_usage_daily
  # ---------------------------------------------------------------------------

  - name: profile_usage_daily
    description: Daily profiling metrics for fact_usage (row counts, volume stats, distinct keys).
    contract:
      enforced: true

    columns:
      - name: report_date
        data_type: date
        tests: [not_null, unique]

      - name: row_count
        data_type: number

      - name: sum_units
        data_type: number

      - name: avg_units
        data_type: number

      - name: stddev_units
        data_type: number(18,6)

      - name: max_units
        data_type: number

      - name: distinct_customers
        data_type: number

      - name: distinct_products
        data_type: number

      - name: distinct_plans
        data_type: number



  # ---------------------------------------------------------------------------
  # usage_anomalies_daily
  # ---------------------------------------------------------------------------

  - name: usage_anomalies_daily
    description: Daily usage volume anomalies vs historical row_count baseline.
    contract:
      enforced: true

    columns:
      - name: report_date
        data_type: date
        tests: [not_null]

      - name: row_count
        data_type: number(38,0)

      - name: avg_daily_row_count
        data_type: number(38,6)
        
      - name: stddev_daily_row_count
        data_type: number(38,6)

      - name: is_row_count_outlier
        data_type: boolean
