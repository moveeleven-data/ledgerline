version: 2

models:
  - name: dim_customer
    description: Customer attributes for the usage mart. One row per natural customer_code.
    config:
      contract:
        enforced: true

    columns:
      - name: customer_key
        data_type: string
        tests: [not_null, unique]

      - name: customer_code
        data_type: string
        tests: [not_null, unique]

      - name: customer_name
        data_type: string
        tests: [not_null]

      - name: country_code
        data_type: string



  - name: dim_product
    description: Product master used by the usage mart. Self completes missing codes from facts using the default member.
    config:
      contract:
        enforced: true

    columns:
      - name: product_key
        data_type: string
        tests: [not_null, unique]

      - name: product_code
        data_type: string
        tests: [not_null, unique]

      - name: product_name
        data_type: string
        tests: [not_null]

      - name: category
        data_type: string



  - name: dim_plan
    description: Subscription plan catalog for the usage mart.
    config:
      contract:
        enforced: true

    columns:
      - name: plan_key
        data_type: string
        tests: [not_null, unique]

      - name: plan_code
        data_type: string
        tests: [not_null, unique]

      - name: plan_name
        data_type: string
        tests: [not_null]

      - name: product_code
        data_type: string
        tests: [not_null]

      - name: billing_period
        data_type: string



  - name: dim_currency
    description: Currency reference data joined to facts when pricing is currency specific.
    config:
      contract:
        enforced: true

    columns:
      - name: currency_key
        data_type: string
        tests: [not_null, unique]

      - name: currency_code
        data_type: string
        tests: [not_null, unique]

      - name: decimal_digits
        data_type: number(38,0)

      - name: currency_name
        data_type: string
        tests: [not_null]



  - name: dim_country
    description: Country reference data for enrichment and rollups.
    config:
      contract:
        enforced: true

    columns:
      - name: country_key
        data_type: string
        tests: [not_null, unique]

      - name: country_code
        data_type: string
        tests: [not_null, unique]

      - name: country_name
        data_type: string
        tests: [not_null]



  - name: fact_usage
    description: Daily usage by customer, product, plan, per report_date. One row per (customer_key, product_key, plan_key, report_date).
    config:
      contract:
        enforced: true

    tests:
      - dbt_utils.unique_combination_of_columns:
          name: fact_usage_unique_combo
          combination_of_columns:
            - customer_key
            - product_key
            - plan_key
            - report_date
            -
    columns:
      - name: customer_key
        data_type: string

        tests:
          - not_null
          - relationships:
              to: ref('dim_customer')
              field: customer_key

      - name: product_key
        data_type: string

        tests:
          - not_null
          - relationships:
              to: ref('dim_product')
              field: product_key

      - name: plan_key
        data_type: string

        tests:
          - not_null
          - relationships:
              to: ref('dim_plan')
              field: plan_key

      - name: report_date
        data_type: date
        tests: [not_null]

      - name: units_used
        data_type: number(38,0)

      - name: included_units
        data_type: number(38,0)

      - name: overage_units
        data_type: number(38,0)

      - name: unit_price
        data_type: number(38,6)

      - name: billed_value
        data_type: number(38,6)

      - name: included_value
        data_type: number(38,6)

      - name: margin_value
        data_type: number(38,6)

      - name: margin_pct
        data_type: number(38,6)
