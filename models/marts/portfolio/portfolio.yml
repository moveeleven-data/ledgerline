version: 2

models:
  - name: DIM_ACCOUNT
    description: Account attributes for the portfolio mart. One row per natural account_code.

    config:
      contract:
        enforced: true

    columns:
      - name: account_key
        description: Surrogate key (hashed) for the account row.
        data_type: string
        tests: [not_null, unique]

      - name: account_code
        description: Natural account code from the provider.
        data_type: string
        tests: [not_null, unique]

      - name: account_currency_code
        description: ISO 4217 currency code for the account’s base currency.
        data_type: string
        tests: [not_null]




  - name: DIM_SECURITY
    description: Security master used by the portfolio mart. Self-completes missing codes from facts using the default member.
    
    config:
      contract:
        enforced: true

    columns:
      - name: security_key
        description: Surrogate key (hashed) for the security row.
        data_type: string
        tests: [not_null, unique]

      - name: security_code
        description: Ticker or instrument code. Acts as the natural key.
        data_type: string
        tests: [not_null, unique]

      - name: security_name
        description: Security display name.
        data_type: string
        tests: [not_null]

      - name: sector_name
        description: GICS or provider sector name, when available.
        data_type: string

      - name: industry_name
        description: GICS or provider industry name, when available.
        data_type: string

      - name: country_code
        description: ISO 3166-1 alpha-2 country code of the issuer, when available.
        data_type: string

      - name: exchange_code
        description: Exchange identifier for the primary listing, when available.
        data_type: string




  - name: DIM_EXCHANGE
    description: Trading exchange reference data.

    config:
      contract:
        enforced: true

    columns:
      - name: exchange_key
        description: Surrogate key (hashed) for the exchange row.
        data_type: string
        tests: [not_null, unique]

      - name: exchange_code
        description: Exchange short code, the natural key.
        data_type: string
        tests: [not_null, unique]

      - name: exchange_name
        description: Full exchange name.
        data_type: string
        tests: [not_null]

      - name: country_name
        description: Country for the exchange’s location.
        data_type: string

      - name: city_name
        description: City for the exchange’s location.
        data_type: string

      - name: timezone_name
        description: Timezone of the exchange (e.g., CET).
        data_type: string

      - name: tz_delta_hours
        description: UTC offset hours as provided in the seed.
        data_type: number(38,0)

      - name: dst_period_desc
        description: Daylight saving period text, when provided.
        data_type: string

      - name: open_local
        description: Local open time in exchange’s timezone.
        data_type: string

      - name: close_local
        description: Local close time in exchange’s timezone.
        data_type: string

      - name: lunch_local
        description: Local lunch interval indicator or time, when provided.
        data_type: string

      - name: open_utc
        description: UTC open time.
        data_type: string

      - name: close_utc
        description: UTC close time.
        data_type: string

      - name: lunch_utc
        description: UTC lunch interval indicator or time, when provided.
        data_type: string




  - name: DIM_CURRENCY
    description: Currency reference data joined to facts on currency code.

    config:
      contract:
        enforced: true

    columns:
      - name: currency_key
        description: Surrogate key (hashed) for the currency row.
        data_type: string
        tests: [not_null, unique]

      - name: currency_code
        description: ISO 4217 alphabetic code, the natural key.
        data_type: string
        tests: [not_null, unique]

      - name: currency_num_code
        description: ISO 4217 numeric code.
        data_type: number(38,0)

      - name: decimal_digits
        description: Typical decimal precision for the currency.
        data_type: number(38,0)

      - name: currency_name
        description: Currency display name.
        data_type: string
        tests: [not_null]

      - name: locations
        description: Countries or regions where the currency is used, when provided.
        data_type: string



  - name: DIM_COUNTRY
    description: Country reference data for enrichment and rollups.

    config:
      contract:
        enforced: true

    columns:
      - name: country_key
        description: Surrogate key (hashed) for the country row.
        data_type: string
        tests: [not_null, unique]

      - name: country_code
        description: ISO 3166-1 alpha-2 country code, the natural key.
        data_type: string
        tests: [not_null, unique]

      - name: country_name
        description: Country name.
        data_type: string
        tests: [not_null]

      - name: region
        description: UN region, when available.
        data_type: string

      - name: sub_region
        description: UN sub-region, when available.
        data_type: string

      - name: iso_code
        description: ISO 3166-2 code, when available.
        data_type: string



  - name: FACT_POSITION
    description: Fact of positions by account, security, exchange, currency, per report_date. One row per (account_key, security_key, exchange_key, currency_key, report_date).
    
    config:
      contract:
        enforced: true

    tests:
      - dbt_utils.unique_combination_of_columns:
          name: fact_position_unique_combo
          combination_of_columns:
            - account_key
            - security_key
            - exchange_key
            - currency_key
            - report_date

    columns:
      - name: account_key
        description: Foreign key to DIM_ACCOUNT.
        data_type: string
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('DIM_ACCOUNT')
                field: account_key

      - name: security_key
        description: Foreign key to DIM_SECURITY.
        data_type: string
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('DIM_SECURITY')
                field: security_key

      - name: exchange_key
        description: Foreign key to DIM_EXCHANGE.
        data_type: string
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('DIM_EXCHANGE')
                field: exchange_key

      - name: currency_key
        description: Foreign key to DIM_CURRENCY.
        data_type: string
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('DIM_CURRENCY')
                field: currency_key

      - name: report_date
        description: As-of business date of the position snapshot.
        data_type: date
        tests: [not_null]

      - name: quantity
        description: Units held as of report_date.
        data_type: number(38,0)

      - name: cost_base
        description: Cost basis for the position as of report_date.
        data_type: number(38,2)

      - name: position_value
        description: Market value for the position as of report_date.
        data_type: number(38,2)

      - name: unrealized_profit
        description: position_value minus cost_base.
        data_type: number(38,2)

      - name: unrealized_profit_pct
        description: (position_value - cost_base) / cost_base * 100, rounded to 5 decimals.
        data_type: number(38,5)
